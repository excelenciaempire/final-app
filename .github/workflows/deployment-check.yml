name: Deployment Health Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Wait for Vercel deployment
        run: |
          echo "Waiting 60 seconds for Vercel deployment to complete..."
          sleep 60

      - name: Check Frontend (Vercel)
        id: frontend-check
        run: |
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL="https://app-spediak.vercel.app"
          fi
          
          echo "Checking frontend at: $FRONTEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Frontend is healthy (HTTP $HTTP_CODE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Frontend returned HTTP $HTTP_CODE"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check Backend (Render)
        id: backend-check
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://spediak-backend.onrender.com"
          fi
          
          echo "Checking backend at: $BACKEND_URL/health"
          RESPONSE=$(curl -s "$BACKEND_URL/health")
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Backend is healthy (HTTP $HTTP_CODE)"
            echo "$RESPONSE" | jq '.'
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Backend returned HTTP $HTTP_CODE"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check Backend Detailed Health
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://spediak-backend.onrender.com"
          fi
          
          echo "Running detailed health check..."
          RESPONSE=$(curl -s "$BACKEND_URL/health/detailed")
          echo "$RESPONSE" | jq '.'
          
          # Check for missing tables
          MISSING_TABLES=$(echo "$RESPONSE" | jq -r '.checks.database_schema.missing_tables[]' 2>/dev/null)
          if [ -n "$MISSING_TABLES" ]; then
            echo "âš ï¸  Warning: Missing database tables detected:"
            echo "$MISSING_TABLES"
            echo "Run migrations: node scripts/run-migrations.js"
          fi
          
          # Check environment variables
          MISSING_ENV=$(echo "$RESPONSE" | jq -r '.checks.environment.missing[]' 2>/dev/null)
          if [ -n "$MISSING_ENV" ]; then
            echo "âš ï¸  Warning: Missing environment variables:"
            echo "$MISSING_ENV"
          fi

      - name: Run Integration Tests
        run: |
          echo "Verifying frontend can reach backend..."
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            BACKEND_URL="https://spediak-backend.onrender.com"
          fi
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/ping")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Integration test passed"
          else
            echo "âŒ Integration test failed"
            exit 1
          fi

      - name: Notify on Success
        if: success()
        run: |
          echo "ðŸŽ‰ All deployment checks passed!"
          echo "Frontend (Vercel): âœ… Healthy"
          echo "Backend (Render): âœ… Healthy"
          echo "Integration: âœ… Working"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment verification failed!"
          echo "Check the logs above for details."
          # You can add Discord/Slack notifications here

      - name: Create Deployment Status
        if: always()
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ steps.frontend-check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ steps.backend-check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

